#
# $Id: Makefile 131597 2009-04-09 06:34:51Z norton $
#


MODULES = \
	jsf \
	jsf_driver \
	jsf_utils \
	ubf_jsonrpc \
	ubf_jsonrpc_inets_httpc_simple \
	ubf_jsonrpc_inets_httpd_simple \
	ubf_jsonrpc_inets_httpd_simple_auth

TESTS = \
	test_plugin \
	jsf_test

EUNITTESTS = \
	ubf_jsonrpc_examples_test \
	ubf_jsonrpc_stateless_plugin \
	ubf_jsonrpc_inets_simple_test

MY_UBF_EBIN = ./example-symlink-to-ubf-ebin
MY_UBF_INCLUDE = ./example-symlink-to-ubf-include

MY_ERLANG_RFC4627_EBIN = ./example-symlink-to-erlang-rfc4627-ebin

# include erl make
include ../priv/make/erl_make.mk

ERL_COMPILE_FLAGS += \
	-I $(MY_UBF_INCLUDE) \
	-pz $(MY_UBF_EBIN)

TESTONLY_ERL_COMPILE_FLAGS += \
	-I $(MY_UBF_INCLUDE) \
	-pz $(MY_UBF_EBIN)

ERL_FLAGS += \
	-pz $(MY_UBF_EBIN)

# standard targets
check: all
	-rm -f ./*.log
	$(RUNERL1) -noinput -noshell -pz $(TEST_DIR) -pz $(EUNITTEST_DIR) -pz $(MY_UBF_EBIN) -pz $(MY_ERLANG_RFC4627_EBIN) \
		-s jsf_test tests \
		-s inets start \
		-s ubf_jsonrpc_examples_test do_eunit \
		-s ubf_jsonrpc_inets_simple_test do_eunit \
		-s erlang halt \
		> ./check.log

# EDoc
edoc: all
	erl -noshell -noinput -eval 'file:set_cwd(".."), {ok, Dir} = file:get_cwd(), edoc:application(ubf_jsonrpc, Dir, [{dir, Dir ++ "/edoc"}]), erlang:halt(0).'
### replace date with \$Id:\$
	perl -i -pe 's!>Generated by EDoc[^<]+<!>Generated EDoc, \$$Id\$$<!g;' \
		../edoc/*.html
### remove time tags
	perl -i -pe 's!(Version:</b>)([^<]+)!$$1 \$$Id!;' \
		../edoc/*.html
### replace bom root with ./
#	perl -i -pe 's!$(DEP_ROOT)!./!g;' \
#		../edoc/*.html
